<html>

<head>
    <title>Firebase Endpoints Demo</title>
</head>

<body>
    <h1>
        There are <span class="user-count">0</span> users.
    </h1>
    <h3>Users</h3>
    <table id="users-table">
        <thead>
            <tr>
                <th>User Key</th>
                <th>User Name</th>
                <th>User Email</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="users-list">
            <tr class="user-description">
                <td class="user-key"></td>
                <td class="user-name"></td>
                <td class="user-email"></td>
                <td>
                    <button class="view-user-tweets">View Tweets</button>
                </td>
            </tr>
        </tbody>
    </table>
    <div id="user-details">
        <ul>
            <li>
                Name: <span class="user-name"></span>
            </li>
            <li>
                Email: <span class="user-email"></span>
            </li>
            <li>
                <h3>Tweets</h3>
                <ul id="user-tweet-list">
                    <li>
                        <strong class="tweet-created"></strong>:
                        <span class="tweet-text"></span>
                    </li>
                </ul>
            </li>
        </ul>
    </div>
    <script src="https://cdn.firebase.com/js/client/2.2.9/firebase.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script type="text/javascript">
    (function() {
        var usersRoot = "https://demos-firebase.firebaseio.com/endpoints/users/",
            usersRef = new Firebase(usersRoot),
            usersList = $('#users-list'),
            userDescriptionTemplate = usersList.html(),
            userDetails = $('#user-details'),
            userDetailsTemplate = userDetails.html();

        usersRef.on('value', function(snap) {
            var users = snap.val(),
                userKeys = Object.keys(users),
                i = userKeys.length,
                key,
                user,
                li;

            console.log('users', users);

            $('.user-count').text(i);

            usersList.empty();

            while (i--) {
                key = userKeys[i];
                user = users[key];

                li = $(userDescriptionTemplate);
                li.attr('user-key', key);
                li.find('.user-key').text(key);
                li.find('.user-name').text(user.name);
                li.find('.user-email').text(user.email);;
                usersList.append(li);
            }
        });

        usersList.on('click', '.view-user-tweets', function(e) {
            var userKey = $(e.target).parents('.user-description').attr('user-key'),
                userRef = new Firebase(usersRoot + userKey);

            userRef.once('value', function(snap) {
                var user = snap.val(),
                    ul = $(userDetailsTemplate),
                    userTweetList = ul.find('#user-tweet-list'),
                    userTweetTemplate = userTweetList.html();

                console.log('user', user);

                userDetails.empty();

                ul.find('.user-key').text(snap.key());
                ul.find('.user-name').text(user.name);
                ul.find('.user-email').text(user.email);

                var tweetKeys = Object.keys(user.tweets),
                    i = tweetKeys.length,
                    tweet,
                    tweetLi;

                userTweetList.empty();

                while (i--) {
                    tweet = user.tweets[tweetKeys[i]];
                    tweetLi = $(userTweetTemplate);
                    tweetLi.find('.tweet-created').text(tweet.created);
                    tweetLi.find('.tweet-text').text(tweet.text);
                    userTweetList.append(tweetLi);
                }

                userDetails.append(ul);

            });
        });

    })();
    </script>
</body>

</html>